---
version: "3"

includes:
  flow: ./flow.yml      # validate / pipeline-local ãªã©
  core: ./core.yml      # COUNT=12 ãªã©å…±é€šå¤‰æ•°

tasks:
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘  å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ ï¼‹ ãƒ—ãƒƒã‚·ãƒ¥
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  commit-push:
    desc: "git pull --rebase â†’ add â†’ commit â†’ push"
    cmds:
      - |
        # 1. å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã—ã¦ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´ãŒç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        git add -A
        git commit -m "task split + COUNT=12 pipeline" || echo "No changes to commit"

        # 2. æœ€æ–° main ã‚’ãƒªãƒ™ãƒ¼ã‚¹
        git pull --rebase origin main || {
          echo "âš ï¸  Rebase ã§è¡çªã—ã¾ã—ãŸã€‚è§£æ±ºå¾Œ â†’ git add <files> && git rebase --continue"; exit 1; }

        # 3. ãƒ—ãƒƒã‚·ãƒ¥
        git push
        echo "âœ…  push å®Œäº†"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘¡ GitHub Actions ã® validate-and-test ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
  #    gh CLI ãŒå¿…è¦ï¼ˆbrew install ghï¼‰
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:wait:
    deps: [commit-push]
    desc: "wait for CI validate-and-test to turn green"
    cmds:
      - |
        # Ensure GitHub CLI is available
        if ! command -v gh >/dev/null 2>&1; then
          echo "ğŸ”§ Installing GitHub CLI via Homebrew â€¦"
          brew install gh || { echo "âŒ Failed to install gh"; exit 1; }
        fi

        WF="validate-and-test"
        SHA=$(git rev-parse HEAD)
        echo "â³ waiting for $WF / $SHA"
        while :; do
          STATUS=$(gh run list -c "$WF" -b "$SHA" --json status -q '.[0].status')
          RESULT=$(gh run list -c "$WF" -b "$SHA" --json conclusion -q '.[0].conclusion')
          echo "â€¦ $STATUS / $RESULT"
          [ "$STATUS" = "completed" ] && break
          sleep 30
        done
        if [ "$RESULT" != "success" ]; then
          echo "âŒ CI failed ($RESULT)"; exit 1
        fi
        echo "ğŸ‰ CI green!"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘¢ ãƒ­ãƒ¼ã‚«ãƒ« 12 ä¸¦åˆ—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œï¼ˆä»»æ„ï¼‰
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  local-run:
    deps: [ci:wait]
    desc: "COUNT=12 ã§ local pipeline (parallel runâ†’pick)"
    cmds:
      - task flow:pipeline-local
      - echo "ğŸš€ local parallel loop finished"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘£ ã™ã¹ã¦ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  done:
    desc: "commit â†’ push â†’ CI wait â†’ local parallel run"
    deps: [local-run]
    cmds:
      - echo "ğŸŒŸ  å…¨å·¥ç¨‹å®Œäº†ï¼" 