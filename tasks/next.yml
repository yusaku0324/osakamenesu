---
version: "3"

includes:
  core: ./core.yml          # COUNT / WT_DIR ãªã©å…±é€šå¤‰æ•°

tasks:
  #--------------------------------------------------#
  # 1) git add â†’ commit â†’ push     (åå‰ä¿®æ­£)
  #    next:commit-push
  #--------------------------------------------------#
  commit-push:
    desc: "stage all â†’ commit â†’ push HEAD"
    cmds:
      - git add -A
      - |
          if git diff --cached --quiet; then
            echo "ğŸŸ¢ nothing to commit (skip commit)"
          else
            git commit -m "fix: green branch squash"
          fi
      - git push -u origin HEAD

  #--------------------------------------------------#
  # 2) CI å¾…æ©Ÿ         (next:ci-wait ã¯ãã®ã¾ã¾å¯)
  #--------------------------------------------------#
  ci-wait:
    desc: "wait until GitHub Actions on HEAD is green"
    vars:
      SHA: "$(git rev-parse HEAD)"
    cmds:
      - |
          while :; do
            STATUS=$(gh run list -c "{{.SHA}}" -b "{{.SHA}}" \
                     --json status   -q '.[0].status'     2>/dev/null || echo none)
            RESULT=$(gh run list -c "{{.SHA}}" -b "{{.SHA}}" \
                     --json conclusion -q '.[0].conclusion' 2>/dev/null || echo none)
            if [ "$STATUS" = none ];            then echo "ğŸ”„ run not found yet"; sleep 20; continue; fi
            if [ "$STATUS" != completed ];      then echo "â³ CI $STATUSâ€¦";      sleep 20; continue; fi
            [ "$RESULT" = success ] && break || { echo "âŒ CI $RESULT"; exit 1; }
          done
      - echo "âœ… CI green!"

  #--------------------------------------------------#
  # 3) ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆé€£é– (åå‰ä¿®æ­£)
  #    next:push-main   â† commit-push â†’ ci-wait
  #--------------------------------------------------#
  push-main:
    desc: "commit-push & wait for CI green"
    deps: [commit-push, ci-wait]
    cmds:
      - echo "ğŸ‰  main branch is green!"

#-------------------------------------------------------------#
# alias: commit:push  (colon style)
#-------------------------------------------------------------#
"commit:push":
  desc: "stage-all â†’ commit â†’ push current branch (alias)"
  deps: [commit-push]
  cmds:
    - echo "âœ… commit:push finished" 