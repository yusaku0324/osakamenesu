---
version: "3"

includes:
  core: ./core.yml        # å…±é€šå¤‰æ•° & hooks
  parallel: ./parallel.yml

vars:
  COVERAGE_MIN: 85        # ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ (%)
  GITHUB_USER: yusaku0324

# ------------------------------------------------------------------
# 1. ãƒ†ã‚¹ãƒˆå¼·åŒ– & ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬
# ------------------------------------------------------------------
tasks:
  test:coverage:
    desc: "pytest -n auto + coverage å®Ÿè¡Œã—ã€é–¾å€¤ã‚’ä¸‹å›ã£ãŸã‚‰å¤±æ•—"
    cmds:
      - pytest -q -n auto --cov=bot --cov-report=xml
      - |
          RATE=$(python - <<'PY'
          import xml.etree.ElementTree as ET
          rate = int(float(ET.parse('coverage.xml').getroot().attrib['line-rate']) * 100)
          print(rate)
          PY
          )
          echo "ğŸ” coverage: ${RATE}%"
          test "${RATE}" -ge "{{.COVERAGE_MIN}}" \
            || { echo "âŒ Coverage ${RATE}% < {{.COVERAGE_MIN}}%"; exit 1; }

  # ------------------------------------------------------------------
  # 2. PR é–‹ç™ºãƒ•ãƒ­ãƒ¼: pre-push ã§ãƒ†ã‚¹ãƒˆ & Lint
  # ------------------------------------------------------------------
  prepush:
    desc: "git push å‰ã« lint + pytest (é€Ÿãƒ¢ãƒ¼ãƒ‰)"
    cmds:
      - ruff check bot tests                 # style / import sort
      - pytest -q -m "not slow"             # ãƒãƒ¼ã‚¯ slow ã‚’é™¤å¤–
    silent: true

  # ------------------------------------------------------------------
  # 3. CD æº–å‚™: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ build & GitHub Packages ã¸ push
  # ------------------------------------------------------------------
  docker:publish:
    desc: "main ãƒ–ãƒ©ãƒ³ãƒã§ã‚¿ã‚°ä»˜ã Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ build & push"
    cmds:
      - |
          TAG=$(git rev-parse --short=8 HEAD)
          docker build -t ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG} .
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            docker login ghcr.io -u {{.GITHUB_USER}} --password-stdin
          docker push ghcr.io/{{.GITHUB_USER}}/kakeru:${TAG}

  # ------------------------------------------------------------------
  # 4. GitHub Actions ã‹ã‚‰å‘¼ã¶ entrypoint
  # ------------------------------------------------------------------
  ci:full:
    desc: "CI ãƒ•ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (coverage â†’ docker publish)"
    deps:
      - test:coverage
      - docker:publish

#-------------------------------------------------------------#
# alias: commit:push  (colon style)
#-------------------------------------------------------------#
"commit:push":
  desc: "stage-all â†’ commit â†’ push current branch (alias)"
  deps: [commit-push]
  cmds:
    - echo "âœ… commit:push finished" 