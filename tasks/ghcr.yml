---
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# tasks/ghcr.yml  â€• GHCR ã‚¤ãƒ¡ãƒ¼ã‚¸æ“ä½œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
#   â–¸ ghcr:list          : GHCR ä¸Šã®ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸€è¦§ã‚’å–å¾—
#   â–¸ ghcr:pull-latest   : latest ã‚’ pull ã—ã¦ smoke-test
#   â–¸ ghcr:prune-obsolete: ä¿æŒæ—¥æ•°ã‚’è¶…ãˆãŸã‚¿ã‚°ã‚’è‡ªå‹•å‰Šé™¤
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
version: "3"

includes:
  core: ./core.yml        # æ—¢å­˜ã® COUNT / WT_DIR ãªã©
  tests: ./tests.yml
  parallel: ./parallel.yml

vars:
  GHCR_USER:  yusaku0324
  GHCR_REPO:  kakeru
  RETAIN_DAYS: 14         # æ—¥æ•°ã‚’å¤‰ãˆãŸã„å ´åˆã¯ã“ã“ã ã‘

tasks:
  list:
    desc: "ä¸€è¦§å–å¾— â€“ gh api ã§ GHCR ã®ã‚¿ã‚°æƒ…å ±ã‚’è¡¨ç¤º"
    cmds:
      - |
        gh api -H "Accept: application/vnd.github+json" \
          /users/{{.GHCR_USER}}/packages/container/{{.GHCR_REPO}}/versions \
          | jq -r '.[] | "\(.name)\t\(.metadata.container.tags[])"'

  pull-latest:
    desc: "latest ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ pull â†’ pytest -q ã§ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ"
    cmds:
      - docker pull ghcr.io/{{.GHCR_USER}}/{{.GHCR_REPO}}:latest
      - docker run --rm ghcr.io/{{.GHCR_USER}}/{{.GHCR_REPO}}:latest \
          pytest -q || { echo 'âŒ smoke test failed'; exit 1; }

  prune-obsolete:
    desc: "RETAIN_DAYS ã‚’è¶ŠãˆãŸã‚¿ã‚°ã‚’è‡ªå‹•å‰Šé™¤"
    summary: |
      GitHub REST v3 ã§æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ â†’ å„ã‚¿ã‚°ã‚’ deleteã€‚CI ã‹ã‚‰é€±1å®Ÿè¡Œæ¨å¥¨ã€‚
    cmds:
      - |
        readarray -t IDS < <(gh api -H "Accept: application/vnd.github+json" \
          /users/{{.GHCR_USER}}/packages/container/{{.GHCR_REPO}}/versions \
          | jq -r --argjson keep {{.RETAIN_DAYS}} \
              '.[] | select((now - (.created_at|fromdate)) > ($keep*86400)) | .id')
        for id in "${IDS[@]}"; do
          echo "ğŸ—‘  delete id $id"
          gh api --method DELETE \
            /user/packages/container/{{.GHCR_REPO}}/versions/"$id"
        done 