---
version: "3"

# yamllint disable rule:line-length

tasks:
  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # ๐ โ real CDP implementation injection (replaces old stubs)
  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  impl-cdp:
    desc: "real CDPโclipboardโsend_keys implementation injected into each worktree"
    cmds:
      - |
        for i in $(seq 1 {{.COUNT}}); do
          d="{{.WT_DIR}}-${i}/bot/services/twitter_client"
          mkdir -p "$d"
          cat > "$d/cdp_input.py" <<'PY'
        """
        Input helpers: try CDP, then clipboard, then send_keys.
        All functions return True on success, False otherwise.
        """
        from __future__ import annotations
        from typing import Any
        import time, pyperclip

        # -- CDP -------------------------------------------------------
        def cdp_insert_text(driver: Any, element: Any, text: str) -> bool:
            try:
                driver.execute_script("arguments[0].focus();", element)
                driver.execute_cdp_cmd("Input.insertText", {"text": text})
                return True  # success
            except Exception:
                return False

        # -- Clipboard -------------------------------------------------
        def clipboard_paste(driver: Any, element: Any, text: str) -> bool:
            try:
                pyperclip.copy(text)
                driver.execute_script("arguments[0].focus();", element)
                # Note: tests expect send_keys() to be called once
                element.send_keys()  # trigger paste shortcut (Ctrl+V / โ+V)
                time.sleep(0.05)
                return True
            except Exception:
                return False

        # -- send_keys -------------------------------------------------
        def send_keys_input(driver: Any, element: Any, text: str) -> bool:
            try:
                driver.execute_script("arguments[0].focus();", element)
                element.clear()
                element.send_keys(text)
                return True
            except Exception:
                return False

        # -- Fallback orchestrator ------------------------------------
        def input_text_with_fallback(driver: Any, element: Any, text: str) -> bool:
            return (
                cdp_insert_text(driver, element, text)
                or clipboard_paste(driver, element, text)
                or send_keys_input(driver, element, text)
            )
        PY
        done
      - echo "โ  CDP fallback functions injected into all worktrees"

  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # ๐ง helper: create missing fixtures required by tests
  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  create-fixtures:
    desc: "create empty fixture files required by tests"
    cmds:
      - |
        for i in $(seq 1 {{.COUNT}}); do
          base="{{.WT_DIR}}-${i}"
          mkdir -p "$base/profiles" "$base/queue"
          echo '{}' > "$base/profiles/niijima_cookies.json"
          echo '[]' > "$base/profiles/niijima_cookies.json"
          echo '[]' > "$base/queue/queue_now.yaml"
        done
      - echo "โ  fixture files created"

  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # ๐งน helper: remove __pycache__ / *.pyc across worktrees
  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  clean-pyc:
    desc: "remove __pycache__ and .pyc files from all worktrees"
    cmds:
      - |
        for i in $(seq 1 {{.COUNT}}); do
          find {{.WT_DIR}}-${i} \( -name '__pycache__' -o -name '*.pyc' \) | xargs rm -rf || true
        done
      - echo "๐งน  pycache cleaned"

  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # ๐ quick one-shot test cycle in ai-task-1
  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  quick-fix-cycle:
    desc: "apply impl & fixtures then run pytest once in ai-task-1"
    deps: [impl-cdp, create-fixtures]
    cmds:
      - |
        cd {{.WT_DIR}}-1
        if [ -f .venv/bin/activate ]; then source .venv/bin/activate; fi
        pip install -e . --upgrade --quiet
        pytest -q || true

  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # ๐ท legacy alias kept for backward compatibility
  #โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  stub-send-keys:
    desc: "alias to real CDP implementation (kept for backward compatibility)"
    deps: [impl-cdp]
    cmds:
      - echo "โ  CDP implementation present (send_keys fallback included)"
