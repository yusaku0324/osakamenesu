---
version: "3"

includes:
  core: ./core.yml

tasks:
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”  CPU ä½¿ç”¨ç‡ / Load Average ã‚’è¡¨ç¤º
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cpu:
    desc: "show current CPU load (uptime & top)"
    cmds:
      - uptime
      - |
        if command -v top >/dev/null 2>&1; then
          if [[ "$(uname)" == "Darwin" ]]; then
            top -l 1 | head -n 10 || true
          else
            top -b -n 1 | head -n 10 || true
          fi
        fi

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“„  ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸€è¦§è¡¨ç¤º
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  log:ls:
    desc: "list recent agent log files in {{.LOG_DIR}}"
    cmds:
      - ls -lh {{.LOG_DIR}} 2>/dev/null | tail -n 20 || echo "(no log files)"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”„  cursor agent ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã™ã¹ã¦å†èµ·å‹•ï¼ˆstop only hereï¼‰
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  restart:
    desc: "kill all running cursor agent processes"
    cmds:
      - |
        echo "ğŸ›‘ stopping cursor agents â€¦"
        if command -v pkill >/dev/null 2>&1; then
          pkill -f "cursor.*agent" || true
        else
          # fallback using ps + kill
          ps aux | grep "cursor.*agent" | grep -v grep | awk '{print $2}' | xargs -r kill -9 || true
        fi
      - echo "âœ…  agents stopped"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§ª å¤±æ•—ãƒ†ã‚¹ãƒˆã‚’ç´ æ—©ãç‰¹å®šã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  tests:first-fail:
    desc: "pytest -x ã§ 1 ä»¶ç›®ã®å¤±æ•—ã‚’è¡¨ç¤º (ai-task-1)"
    cmds:
      - |
        cd ../ai-task-1
        if [ -f .venv/bin/activate ]; then source .venv/bin/activate; fi
        echo "â–¶ï¸ showing first failing test in ai-task-1"
        pytest -q tests -x

  tests:fail:
    desc: "pytest -x in ai-task-<N> (default 1)"
    vars:
      IDX: "{{.CLI_ARGS | default `1`}}"
    cmds:
      - |
        cd ../ai-task-{{.IDX}}
        if [ -f .venv/bin/activate ]; then source .venv/bin/activate; fi
        echo "â–¶ï¸ ai-task-{{.IDX}} first failing test"
        pytest -q tests -x

  log:tail:
    desc: "tail -f logs/run_<N>.log (default 1)"
    vars:
      N: "{{.CLI_ARGS | default `1`}}"
    cmds:
      - tail -f ../../logs/run_{{.N}}.log 