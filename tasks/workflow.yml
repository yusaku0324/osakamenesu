---
version: "3"

includes:
  core: ./core.yml        # COUNT / WT_DIR / LOG_DIR
  debug: ./debug.yml      # tests:first-fail / tests:lf ãªã©
  flow: ./flow.yml        # validate
  parallel: ./parallel.yml    # parallel:run / parallel:pick
  next: ./next.yml        # commit-push / ci:wait

vars:
  COUNT: 12           # ä¸¦åˆ—æœ¬æ•°ã‚’å›ºå®š

tasks:
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘  å¤‰æ›´ç›´å¾Œï¼šFAIL 1 ä»¶ç›®ã ã‘è¦‹ã‚‹
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  small-fix:
    desc: "pytest first FAIL â†’ è‡ªåˆ†ã§ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã—ã¦ä¸Šæ›¸ãä¿å­˜"
    cmds:
      - task debug:tests:first-fail

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘¡ ai-task-1 ã§ãƒ•ãƒ«ã‚¹ã‚¤ãƒ¼ãƒˆï¼ˆxdistï¼‰
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  full-validate:
    desc: "ai-task-1 full pytest (-n auto)"
    cmds:
      - task flow:validate

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘¢ 12 ä¸¦åˆ—ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ â†’ æœ€åˆã®ç·‘ã‚’ main ã¸
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  screen-12:
    desc: "parallel run COUNT=12 â†’ pick green branch"
    deps:
      - small-fix
      - full-validate
    cmds:
      - export TASK_COUNT={{.COUNT}}
      - task parallel:run
      - task parallel:pick

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘£ rebase â†’ commit â†’ push â†’ (gh èªè¨¼ã‚ã‚Œã°) CI wait
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  push-main:
    desc: "pull --rebase â†’ commit & push â†’ optional CI wait"
    deps: [screen-12]
    cmds:
      - task next:commit-push
      - task next:ci:wait        # gh æœªèªè¨¼ãªã‚‰è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â‘¤ å¤œé–“ãƒãƒƒãƒï¼šå…¨å·¥ç¨‹ã‚’ 1 ã‚³ãƒãƒ³ãƒ‰ã§å›ã™
  #    ä¾‹ï¼‰crontab:  0 3 * * *  cd /repo && task workflow:nightly-auto
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  nightly-auto:
    desc: "shared venv â†’ link tests â†’ run full pipeline & push"
    deps:
      - venv:create-shared       # â† å…±æœ‰ venv ãŒç„¡ã‘ã‚Œã°ä½œæˆ
      - tests:link               # â† main/tests ã‚’å„ WT ã«ãƒªãƒ³ã‚¯
      - full-validate
      - screen-12
      - push-main
    cmds:
      - echo "ğŸŒ™ nightly pipeline completed" 