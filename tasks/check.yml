---
version: "3"

includes:
  core: ./core.yml        # COUNT / LOG_DIR å¤‰æ•°
  debug: ./debug.yml      # cpu / log / log:ls / restart ãªã©

tasks:
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŸ¢  ç¾åœ¨ç¨¼åƒä¸­ã® cursor agent æ•°ã‚’è¡¨ç¤º
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  agents:
    desc: "pgrep ã§ cursor agent ä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ"
    cmds:
      - |
        if command -v pgrep >/dev/null 2>&1; then
          CNT=$(pgrep -fl "cursor.*agent" | wc -l | tr -d ' ')
        else
          CNT=$(ps aux | grep "cursor.*agent" | grep -v grep | wc -l | tr -d ' ')
        fi
        echo "ğŸ‘€  running cursor agent: ${CNT} ä»¶"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŸ¢  ç¾åœ¨ã® CI (validate-and-test) ã®æœ€æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ 1 è¡Œè¡¨ç¤º
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    desc: "GitHub Actions validate-and-test â¤µï¸ status (skip if gh æœªèªè¨¼)"
    cmds:
      - |
        if ! gh auth status >/dev/null 2>&1; then
          echo "ğŸ”’ gh æœªèªè¨¼ â†’ CI ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—"; exit 0; fi
        SHA=$(git rev-parse HEAD)
        WF="validate-and-test"
        gh run list -c "$WF" -b "$SHA" --limit 1 --json status,conclusion -q \
          '"ğŸ›   CI: \(.[] .status) / \(.[] .conclusion)"' \
          || echo "ğŸ›   CI: run not found"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŸ¢  å…±æœ‰ venv ã‚µã‚¤ã‚ºã¨ SSD ç©ºãå®¹é‡è¡¨ç¤º
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  disk:
    desc: "du ã§ shared venv & df ã§ç©ºãå®¹é‡"
    cmds:
      - du -sh {{.SHARED_VENV}} || echo "shared venv æœªä½œæˆ"
      - df -h .

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ  ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  all:
    desc: "CPUâ–¶ï¸ãƒ­ã‚°ä¸€è¦§â–¶ï¸agent ä»¶æ•°â–¶ï¸CIâ–¶ï¸disk ã‚’ä¸€æ‹¬è¡¨ç¤º"
    cmds:
      - task debug:cpu
      - task debug:log:ls
      - task check:agents
      - task check:ci
      - task check:disk 