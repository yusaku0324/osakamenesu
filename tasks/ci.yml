---
version: "3"

vars:
  BRANCH: "{{.CLI_ARGS | default `main`}}"

tasks:
  # --------------------------------------------------
  # 1ï¸âƒ£  GitHub Actions ç”¨ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆ Push
  # --------------------------------------------------
  push:
    desc: "git add -A â†’ commit â†’ push (HEADâ†”origin/{{.BRANCH}})"
    cmds:
      - git add -A
      - |
          if git diff --cached --quiet; then
            echo "ğŸŸ¢ nothing to commit (skip)"; 
          else
            git commit -m "ci: auto-push"
          fi
      - git push -u origin HEAD:{{.BRANCH}}

  # --------------------------------------------------
  # 2ï¸âƒ£  GitHub Actions ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…æ©Ÿ
  # --------------------------------------------------
  wait:
    desc: "poll GitHub Actions until workflow {{.BRANCH}} finishes"
    deps: [push]
    cmds:
      - |
          while :; do
            SHA=$(git rev-parse HEAD)
            STATUS=$(gh run list -c "$SHA" -b "$SHA" \
                       --json status   -q '.[0].status'     2>/dev/null || echo none)
            RESULT=$(gh run list -c "$SHA" -b "$SHA" \
                       --json conclusion -q '.[0].conclusion' 2>/dev/null || echo none)

            [[ "$STATUS" == none       ]] && { echo "ğŸ”„ run not found yet"; sleep 20; continue; }
            [[ "$STATUS" != completed  ]] && { echo "â³ CI $STATUSâ€¦";      sleep 20; continue; }

            [[ "$RESULT" == success ]] && { echo "ğŸ‰ CI success"; exit 0; }
            echo "âŒ CI $RESULT"; exit 1
          done 