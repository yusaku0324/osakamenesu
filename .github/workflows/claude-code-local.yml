name: Claude Code Local
on:
  workflow_dispatch:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-respond:
    runs-on: self-hosted
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, '@claude')) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Claude Code Environment
        run: |
          # Claude Codeãƒã‚¤ãƒŠãƒªã®ãƒ‘ã‚¹ã‚’ç¢ºèª
          CLAUDE_PATH=""
          
          # 1. npm global installation
          if [ -f "$HOME/.npm-global/bin/claude" ]; then
            CLAUDE_PATH="$HOME/.npm-global/bin/claude"
          # 2. Local user installation
          elif [ -f "$HOME/.local/bin/claude" ]; then
            CLAUDE_PATH="$HOME/.local/bin/claude"
          # 3. System installation
          elif command -v claude &> /dev/null; then
            CLAUDE_PATH=$(which claude)
          else
            echo "Error: Claude Code not found"
            exit 1
          fi
          
          echo "Found Claude Code at: $CLAUDE_PATH"
          echo "CLAUDE_PATH=$CLAUDE_PATH" >> $GITHUB_ENV
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          $CLAUDE_PATH --version || echo "Version check failed"

      - name: Process Claude Request
        id: claude
        run: |
          # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ½å‡º
          case "${{ github.event_name }}" in
            issue_comment)
              REQUEST="${{ github.event.comment.body }}"
              CONTEXT="Issue #${{ github.event.issue.number }} comment"
              ;;
            pull_request)
              REQUEST="${{ github.event.pull_request.body }}"
              CONTEXT="PR #${{ github.event.pull_request.number }}"
              ;;
            issues)
              REQUEST="${{ github.event.issue.body }}"
              CONTEXT="Issue #${{ github.event.issue.number }}"
              ;;
            workflow_dispatch)
              REQUEST="Claude Code Local integration test"
              CONTEXT="Manual workflow run"
              ;;
          esac
          
          # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          REQUEST=$(echo "$REQUEST" | sed 's/@claude//g' | xargs)
          
          echo "Context: $CONTEXT"
          echo "Processing request..."
          
          # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          WORK_DIR="/tmp/claude-work-$$"
          mkdir -p "$WORK_DIR"
          cd "$WORK_DIR"
          
          # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$REQUEST" > request.txt
          
          # Claude Codeã‚’å®Ÿè¡Œï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼‰
          # æ³¨: Claude Codeã¯é€šå¸¸ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã®ã§ã€ãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
          RESPONSE=""
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æä¾›
          if [ -f "$GITHUB_WORKSPACE/README.md" ]; then
            echo "Project: ${{ github.repository }}" > context.txt
            echo "Branch: ${{ github.ref_name }}" >> context.txt
            echo "" >> context.txt
            cat "$GITHUB_WORKSPACE/README.md" | head -50 >> context.txt
          fi
          
          # ã‚·ãƒ³ãƒ—ãƒ«ãªå¿œç­”ã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã®Claude Codeã®å‹•ä½œã«ä¾å­˜ï¼‰
          if echo "$REQUEST" | grep -qi "hello\|hi\|ã“ã‚“ã«ã¡ã¯"; then
            RESPONSE="ã“ã‚“ã«ã¡ã¯ï¼GitHubãƒªãƒã‚¸ãƒˆãƒª '${{ github.repository }}' ã§Claude CodeãŒå‹•ä½œã—ã¦ã„ã¾ã™ã€‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
          elif echo "$REQUEST" | grep -qi "test\|ãƒ†ã‚¹ãƒˆ"; then
            RESPONSE="Claude Code Localãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚âœ…\n\nç’°å¢ƒæƒ…å ±:\n- Runner: self-hosted\n- Repository: ${{ github.repository }}\n- Event: ${{ github.event_name }}"
          elif echo "$REQUEST" | grep -qi "analyze\|åˆ†æ\|è§£æ"; then
            RESPONSE="ã‚³ãƒ¼ãƒ‰åˆ†ææ©Ÿèƒ½ã¯ç¾åœ¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šé«˜åº¦ãªåˆ†æã«ã¯Claude APIã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚"
          else
            RESPONSE="ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ: '$REQUEST'\n\nç¾åœ¨ã€Claude Code Localãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚APIã‚­ãƒ¼ãªã—ã§åŸºæœ¬çš„ãªå¿œç­”ã®ã¿å¯èƒ½ã§ã™ã€‚"
          fi
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          cd /
          rm -rf "$WORK_DIR"
          
          # ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          RESPONSE=$(echo "$RESPONSE" | sed 's/\\/\\\\/g' | sed 's/`/\\`/g' | sed 's/\$/\\$/g' | sed "s/'/\\\\'/g" | sed 's/"/\\"/g')
          
          # å¿œç­”ã‚’ä¿å­˜
          echo "CLAUDE_RESPONSE<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.claude.outputs.CLAUDE_RESPONSE }}`;
            
            let issueNumber;
            const eventName = context.eventName;
            
            if (eventName === 'issue_comment') {
              issueNumber = context.issue.number;
            } else if (eventName === 'pull_request') {
              issueNumber = context.payload.pull_request.number;
            } else if (eventName === 'issues') {
              issueNumber = context.issue.number;
            }
            
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `### Claude Response ğŸ¤–\n\n${response}\n\n---\n_Claude Code Local Mode (No API Required)_`
              });
            } else if (eventName === 'workflow_dispatch') {
              console.log('Manual test completed');
              console.log('Response:', response);
            }