name: Claude Code Analyzer
on:
  workflow_dispatch:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  analyze:
    runs-on: self-hosted
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, '@claude'))
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Analyze Code Request
        id: analyze
        run: |
          # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ½å‡º
          case "${{ github.event_name }}" in
            issue_comment)
              REQUEST="${{ github.event.comment.body }}"
              CONTEXT_TYPE="issue"
              CONTEXT_NUM="${{ github.event.issue.number }}"
              ;;
            pull_request)
              REQUEST="${{ github.event.pull_request.body }}"
              CONTEXT_TYPE="pr"
              CONTEXT_NUM="${{ github.event.pull_request.number }}"
              # PR ã®å ´åˆã¯å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
              git diff --name-only origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} > changed_files.txt
              ;;
            workflow_dispatch)
              REQUEST="analyze code"
              CONTEXT_TYPE="manual"
              CONTEXT_NUM="0"
              ;;
          esac
          
          # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          REQUEST=$(echo "$REQUEST" | sed 's/@claude//g' | xargs)
          
          echo "Request: $REQUEST"
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
          RESPONSE=""
          
          # ã‚³ãƒ¼ãƒ‰è§£æã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ãƒã‚§ãƒƒã‚¯
          if echo "$REQUEST" | grep -Ei "ã‚³ãƒ¼ãƒ‰|code|å•é¡Œ|issue|analyze|åˆ†æ|è§£æ|è¦‹|check|review"; then
            echo "Code analysis requested..."
            
            # ãƒ•ã‚¡ã‚¤ãƒ«åãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            FILE_PATTERN=$(echo "$REQUEST" | grep -oE '[a-zA-Z0-9_/-]+\.(py|js|ts|tsx|jsx|yml|yaml|sh|md|json)' || echo "")
            
            if [ -n "$FILE_PATTERN" ]; then
              # ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
              if [ -f "$FILE_PATTERN" ]; then
                RESPONSE="ğŸ“„ **ãƒ•ã‚¡ã‚¤ãƒ«è§£æ: $FILE_PATTERN**\n\n"
                
                # ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æƒ…å ±
                FILE_SIZE=$(wc -c < "$FILE_PATTERN")
                FILE_LINES=$(wc -l < "$FILE_PATTERN")
                RESPONSE="${RESPONSE}ğŸ“Š åŸºæœ¬æƒ…å ±:\n"
                RESPONSE="${RESPONSE}- ã‚µã‚¤ã‚º: $FILE_SIZE bytes\n"
                RESPONSE="${RESPONSE}- è¡Œæ•°: $FILE_LINES lines\n\n"
                
                # ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¡¨ç¤ºï¼ˆæœ€åˆã®30è¡Œï¼‰
                RESPONSE="${RESPONSE}ğŸ“ å†…å®¹ï¼ˆæœ€åˆã®30è¡Œï¼‰:\n\`\`\`\n"
                head -30 "$FILE_PATTERN" > /tmp/file_content.txt
                FILE_CONTENT=$(cat /tmp/file_content.txt | sed 's/`/\\`/g')
                RESPONSE="${RESPONSE}${FILE_CONTENT}\n\`\`\`\n\n"
                
                # ç°¡æ˜“çš„ãªã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
                RESPONSE="${RESPONSE}ğŸ” ç°¡æ˜“ãƒã‚§ãƒƒã‚¯:\n"
                
                # TODO/FIXMEã®ãƒã‚§ãƒƒã‚¯
                TODO_COUNT=$(grep -i "TODO\|FIXME" "$FILE_PATTERN" | wc -l || echo "0")
                if [ "$TODO_COUNT" -gt 0 ]; then
                  RESPONSE="${RESPONSE}- âš ï¸ TODO/FIXMEãŒ${TODO_COUNT}å€‹è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ\n"
                fi
                
                # é•·ã„è¡Œã®ãƒã‚§ãƒƒã‚¯
                LONG_LINES=$(awk 'length > 120' "$FILE_PATTERN" | wc -l || echo "0")
                if [ "$LONG_LINES" -gt 0 ]; then
                  RESPONSE="${RESPONSE}- âš ï¸ 120æ–‡å­—ã‚’è¶…ãˆã‚‹è¡ŒãŒ${LONG_LINES}è¡Œã‚ã‚Šã¾ã™\n"
                fi
                
              else
                RESPONSE="âŒ ãƒ•ã‚¡ã‚¤ãƒ« '$FILE_PATTERN' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
              fi
              
            elif [ "$CONTEXT_TYPE" = "pr" ] && [ -f "changed_files.txt" ]; then
              # PRã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
              RESPONSE="ğŸ”„ **PR #$CONTEXT_NUM ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«è§£æ**\n\n"
              RESPONSE="${RESPONSE}ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:\n"
              
              while IFS= read -r file; do
                if [ -f "$file" ]; then
                  RESPONSE="${RESPONSE}- âœ… $file\n"
                else
                  RESPONSE="${RESPONSE}- âŒ $file (å‰Šé™¤æ¸ˆã¿)\n"
                fi
              done < changed_files.txt
              
              # å¤‰æ›´ã®çµ±è¨ˆ
              ADDITIONS=$(git diff --shortstat origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
              DELETIONS=$(git diff --shortstat origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
              
              RESPONSE="${RESPONSE}\nğŸ“Š å¤‰æ›´çµ±è¨ˆ:\n"
              RESPONSE="${RESPONSE}- è¿½åŠ : +${ADDITIONS} è¡Œ\n"
              RESPONSE="${RESPONSE}- å‰Šé™¤: -${DELETIONS} è¡Œ\n"
              
            else
              # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æ¦‚è¦
              RESPONSE="ğŸ“‚ **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦**\n\n"
              
              # ä¸»è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
              RESPONSE="${RESPONSE}ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ:\n"
              PY_COUNT=$(find . -name "*.py" -type f | wc -l || echo "0")
              JS_COUNT=$(find . -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" -type f | wc -l || echo "0")
              YML_COUNT=$(find . -name "*.yml" -o -name "*.yaml" -type f | wc -l || echo "0")
              
              RESPONSE="${RESPONSE}- Python: ${PY_COUNT} files\n"
              RESPONSE="${RESPONSE}- JavaScript/TypeScript: ${JS_COUNT} files\n"
              RESPONSE="${RESPONSE}- YAML: ${YML_COUNT} files\n\n"
              
              # æœ€è¿‘å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
              RESPONSE="${RESPONSE}ğŸ• æœ€è¿‘å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:\n"
              find . -type f -name "*.py" -o -name "*.js" -o -name "*.ts" | head -5 | while read -r file; do
                RESPONSE="${RESPONSE}- $file\n"
              done
            fi
            
          else
            # é€šå¸¸ã®å¿œç­”
            if echo "$REQUEST" | grep -qi "hello\|hi\|ã“ã‚“ã«ã¡ã¯"; then
              RESPONSE="ã“ã‚“ã«ã¡ã¯ï¼ã‚³ãƒ¼ãƒ‰è§£æãŒå¿…è¦ãªå ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã™ã‚‹ã‹ã€Œã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚\n\nä¾‹:\n- @claude bot/main.py ã‚’è¦‹ã¦\n- @claude ã“ã®PRã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦"
            else
              RESPONSE="ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚\n\nã‚³ãƒ¼ãƒ‰è§£ææ©Ÿèƒ½ã®ä½¿ã„æ–¹:\n- ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«: @claude [ãƒ•ã‚¡ã‚¤ãƒ«å] ã‚’è¦‹ã¦\n- PRå…¨ä½“: PRã§ @claude ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦\n- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦: @claude ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ†æã—ã¦"
            fi
          fi
          
          # ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          RESPONSE=$(echo "$RESPONSE" | sed 's/\\/\\\\/g' | sed 's/`/\\`/g' | sed 's/\$/\\$/g' | sed "s/'/\\\\'/g" | sed 's/"/\\"/g')
          
          # å¿œç­”ã‚’ä¿å­˜
          echo "CLAUDE_RESPONSE<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Analysis Response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.analyze.outputs.CLAUDE_RESPONSE }}`;
            
            let issueNumber;
            const eventName = context.eventName;
            
            if (eventName === 'issue_comment') {
              issueNumber = context.issue.number;
            } else if (eventName === 'pull_request') {
              issueNumber = context.payload.pull_request.number;
            }
            
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `### Claude Code Analysis ğŸ”\n\n${response}\n\n---\n_Code Analyzer (Local Mode - No API Required)_`
              });
            }